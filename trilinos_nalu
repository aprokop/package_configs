#!/usr/bin/env bash
EXTRA_ARGS=$@

rm -f  CMakeCache.txt
rm -rf CMakeFiles/

ARGS=(
    -D CMAKE_BUILD_TYPE=RELWITHDEBINFO

    -D CMAKE_INSTALL_PREFIX="$HOME/local/opt/trilinos-nalu"

    -D BUILD_SHARED_LIBS=ON

    ### COMPILERS AND FLAGS ###
    -D Trilinos_TPL_SYSTEM_INCLUDE_DIRS=ON

    ### TPLS ###
    -D TPL_ENABLE_MPI=ON
    -D TPL_ENABLE_BLAS=ON
        -D BLAS_LIBRARY_NAMES="openblas"
    -D TPL_ENABLE_LAPACK=ON
        -D LAPACK_LIBRARY_NAMES="openblas"
    -D TPL_ENABLE_BoostLib=ON
    -D TPL_ENABLE_HDF5=ON
        # -D TPL_HDF5_LIBRARIES="libhdf5_hl.a;libhdf5.a;libz.a"
        -D TPL_HDF5_LIBRARIES="-lhdf5_hl;-lhdf5;-lz"
    -D TPL_ENABLE_Netcdf=ON
        # -D TPL_Netcdf_LIBRARIES="libnetcdf.a;libpnetcdf.a;libhdf5_hl.a;libhdf5.a;libz.a"
        -D TPL_Netcdf_LIBRARIES="-lnetcdf;-lpnetcdf;-lhdf5_hl;-lhdf5;-lz"
        # -D TPL_Netcdf_Enables_Netcdf4=ON
        -D TPL_Netcdf_PARALLEL=ON
    -D TPL_ENABLE_X11=OFF
    -D TPL_ENABLE_Zlib=ON

    ### ETI ###
    -D Trilinos_ENABLE_EXPLICIT_INSTANTIATION=ON
        -D Tpetra_INST_DOUBLE=ON
        -D Tpetra_INST_INT_LONG=ON
        -D Tpetra_INST_COMPLEX_DOUBLE=OFF

    ### PACKAGES CONFIGURATION ###
    -D Trilinos_ALLOW_NO_PACKAGES=OFF
    -D Trilinos_ASSERT_MISSING_PACKAGES=OFF

    -D Trilinos_ENABLE_TESTS=OFF
    -D Trilinos_ENABLE_EXAMPLES=OFF
    -D Trilinos_ENABLE_ALL_OPTIONAL_PACKAGES=OFF

    -D Trilinos_ENABLE_Amesos=ON
    -D Trilinos_ENABLE_Amesos2=ON
    -D Trilinos_ENABLE_AztecOO=ON
    -D Trilinos_ENABLE_Belos=ON
    -D Trilinos_ENABLE_Epetra=ON
    -D Trilinos_ENABLE_EpetraExt=ON
    -D Trilinos_ENABLE_Gtest=ON
    -D Trilinos_ENABLE_Ifpack=ON
    -D Trilinos_ENABLE_Ifpack2=ON
    -D Trilinos_ENABLE_ML=ON
    -D Trilinos_ENABLE_MueLu=ON
        -D MueLu_ENABLE_EXAMPLES=ON
        -D MueLu_ENABLE_TESTS=ON
    -D Trilinos_ENABLE_SEACAS=ON
        -D Trilinos_ENABLE_SEACASEpu=ON
        -D Trilinos_ENABLE_SEACASExodiff=ON
        -D Trilinos_ENABLE_SEACASExodus=ON
        -D Trilinos_ENABLE_SEACASNemslice=ON
        -D Trilinos_ENABLE_SEACASNemspread=ON
    -D Trilinos_ENABLE_STK=ON
        -D Trilinos_ENABLE_STKClassic=OFF
        -D Trilinos_ENABLE_STKIO=ON
        -D Trilinos_ENABLE_STKMesh=ON
        -D Trilinos_ENABLE_STKSearch=ON
        -D Trilinos_ENABLE_STKTopology=ON
        -D Trilinos_ENABLE_STKTransfer=ON
        -D Trilinos_ENABLE_STKUtil=ON
        -D Trilinos_ENABLE_STKDoc_tests=OFF
        -D Trilinos_ENABLE_STKUnit_tests=ON
        -D Trilinos_ENABLE_STKUnit_test_utils=ON
    -D Trilinos_ENABLE_Tpetra=ON
    -D Trilinos_ENABLE_Zoltan=ON
    -D Trilinos_ENABLE_Zoltan2=ON

    ### MISC ###
    -D CMAKE_VERBOSE_MAKEFILE=OFF
    -D CMAKE_EXPORT_COMPILE_COMMANDS=ON
    -D Trilinos_VERBOSE_CONFIGURE=OFF
    -D Trilinos_ENABLE_INSTALL_CMAKE_CONFIG_FILES=ON
    -D Trilinos_DEPS_XML_OUTPUT_FILE=""

    )
# Cannot use ninja as some packages require Fortran
cmake "${ARGS[@]}" $EXTRA_ARGS ../../

# Record environment for future
[[ -f build.env    ]] && mv build.env    build.env.old
[[ -f build.module ]] && mv build.module build.module.old
env          > build.env
module list &> build.module
